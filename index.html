<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decline Curve Analysis (DCA) - Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* STREAMLIT-LIKE STYLING */
        :root {
            --primary-color: #ff4b4b;
            --secondary-color: #0083B8;
            --text-color: #31333F;
            --bg-color: #ffffff;
            --sidebar-bg: #f0f2f6;
            --font-family: 'Source Sans Pro', sans-serif;
        }

        body {
            font-family: var(--font-family);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 450px; 
            background-color: var(--sidebar-bg);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            border-right: 1px solid rgba(0,0,0,0.05);
            transition: margin-left 0.3s ease;
        }

        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                z-index: 50;
                height: 100%;
                margin-left: -450px;
            }
            #sidebar.open {
                margin-left: 0;
                box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            }
        }

        #main-container {
            flex-grow: 1;
            padding: 2rem 3rem;
            overflow-y: auto;
            position: relative;
        }

        @media (max-width: 640px) {
            #main-container { padding: 1rem; }
        }

        /* UI Elements */
        .slider-container { margin-bottom: 1.5rem; }
        
        .slider-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;
        }
        
        .slider-label { font-size: 13px; font-weight: 600; color: var(--text-color); }
        
        .val-input {
            width: 80px;
            font-family: monospace;
            font-size: 13px;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 5px;
            text-align: right;
        }
        .val-input:focus { border-color: var(--primary-color); outline: none; }

        /* SLIDER STYLING (UPDATED FOR FIREFOX COMPATIBILITY) */
        input[type=range] {
            -webkit-appearance: none; 
            appearance: none; 
            width: 100%; 
            background: transparent; 
            cursor: pointer;
        }

        /* WebKit (Chrome, Safari, Edge) */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #d1d5db; border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--primary-color); margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 2px solid white;
        }

        /* Firefox */
        input[type=range]::-moz-range-track {
            width: 100%; height: 6px; cursor: pointer; background: #d1d5db; border-radius: 3px;
        }
        input[type=range]::-moz-range-thumb {
            height: 16px; width: 16px; border: 2px solid white; border-radius: 50%;
            background: var(--primary-color); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .st-button {
            background-color: #ffffff; color: var(--text-color); border: 1px solid rgba(49, 51, 63, 0.2);
            border-radius: 0.5rem; padding: 0.5rem 1rem; font-weight: 600; cursor: pointer; width: 100%;
            transition: all 0.2s; font-size: 14px; margin-bottom: 0.5rem;
        }
        .st-button:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .st-button.primary { background-color: var(--primary-color); color: white; border: none; }
        .st-button.primary:hover { background-color: #ff3333; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .st-button.success { background-color: var(--secondary-color); color: white; border: none; }
        .st-button.success:hover { background-color: #006892; }

        .st-radio-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .st-radio-option { display: flex; align-items: center; cursor: pointer; font-size: 14px; font-weight: 600; }
        .st-radio-option input { margin-right: 0.5rem; accent-color: var(--primary-color); }

        .st-textarea { border: 1px solid #d6d6d8; border-radius: 0.25rem; padding: 8px; width: 100%; font-size: 12px; font-family: monospace; min-height: 100px; resize: vertical; }
        .st-date-input { border: 1px solid #d6d6d8; border-radius: 0.25rem; padding: 4px 8px; width: 100%; font-size: 13px; color: #333; }

        .hamburger { position: absolute; top: 0.5rem; left: 0.5rem; cursor: pointer; padding: 0.5rem; z-index: 60; color: #555; display: none; }
        @media (max-width: 768px) { .hamburger { display: block; } }
        .top-right-decoration { position: absolute; top: 0; right: 0; height: 4px; width: 100%; background: linear-gradient(90deg, #ff4b4b 0%, #ff4b4b 100%); z-index: 100; }
        
        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 200; align-items: center; justify-content: center;
        }

        .input-tab { display: none; }
        .input-tab.active { display: block; }

        /* Project File Input Hidden */
        #projectFileInput { display: none; }
    </style>
</head>
<body>

    <div class="top-right-decoration"></div>
    
    <div id="loadingOverlay">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-red-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div class="font-bold text-gray-700">Running Regression...</div>
        </div>
    </div>

    <div class="hamburger" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
        
        <h2 style="font-size: 1.5rem; margin-top: 0; margin-bottom: 1rem;">Decline Curve Parameters</h2>
        
        <!-- (WELL INFO REMOVED FROM HERE) -->

        <!-- FLUID TYPE -->
        <label class="slider-label">Fluid Type</label>
        <div class="st-radio-group">
            <label class="st-radio-option">
                <input type="radio" name="fluidType" value="oil" checked onchange="handleFluidChange()"> Oil
            </label>
            <label class="st-radio-option">
                <input type="radio" name="fluidType" value="gas" onchange="handleFluidChange()"> Gas
            </label>
        </div>

        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 1rem 0;">

        <!-- PARAMETER SLIDERS -->
        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Initial Rate, qi (<span id="unit-qi">BOPD</span>)</span>
                <input type="number" id="input-qi-num" class="val-input" onchange="syncInput('qi', 'num')">
            </div>
            <input type="range" id="input-qi" min="10" max="2000" step="1" oninput="syncInput('qi', 'slider')">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Initial Decline, Di (%/year)</span>
                <input type="number" id="input-di-num" class="val-input" onchange="syncInput('di', 'num')">
            </div>
            <input type="range" id="input-di" min="1" max="300" step="0.5" value="20" oninput="syncInput('di', 'slider')">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Hyperbolic Exponent, b</span>
                <input type="number" id="input-b-num" class="val-input" step="0.05" onchange="syncInput('b', 'num')">
            </div>
            <input type="range" id="input-b" min="0" max="1.0" step="0.05" value="0.5" oninput="syncInput('b', 'slider')">
            <div class="text-[10px] text-gray-400 mt-1 italic">Note: If b=0, it is Exponential</div>
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Forecast Start Date</span>
            </div>
            <input type="date" id="input-date-start" class="st-date-input" onchange="handleDateInput()">
            <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                <span>Shift (Months): <span id="val-time-shift" class="font-mono text-primary font-bold">0</span></span>
            </div>
            <input type="range" id="input-time-shift" min="-60" max="60" step="1" value="0" oninput="handleTimeShiftSlider()">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Forecast Duration (Months)</span>
                <input type="number" id="input-months-num" class="val-input" onchange="syncInput('months', 'num')">
            </div>
            <input type="range" id="input-months" min="1" max="600" step="1" value="120" oninput="syncInput('months', 'slider')">
        </div>

        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Economic Limit (<span id="unit-el">BOPD</span>)</span>
                <input type="number" id="input-el-num" class="val-input" onchange="syncInput('el', 'num')">
            </div>
            <input type="range" id="input-el" min="0" max="500" step="1" value="50" oninput="syncInput('el', 'slider')">
        </div>

        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 1.5rem 0;">

        <!-- REGRESSION CONTROLS -->
        <label class="slider-label" style="display:block; margin-bottom:0.5rem; color:var(--secondary-color);">Auto-Fit Regression</label>
        
        <!-- Checkbox to Enable/Disable Window -->
        <div class="flex items-center gap-2 mb-2">
             <input type="checkbox" id="check-reg-window" onchange="toggleRegWindow()" class="w-3 h-3 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
             <label for="check-reg-window" class="text-xs font-medium text-gray-700 cursor-pointer">Enable Regression Window</label>
        </div>

        <div id="reg-window-container" class="bg-blue-50 p-3 rounded border border-blue-100 mb-2" style="display:none;">
            <div class="flex justify-between text-xs mb-1 text-gray-600">
                <span>Start Date</span>
                <span id="reg-start-date" class="font-mono font-bold">-</span>
            </div>
            <input type="range" id="input-reg-start" min="0" max="10" step="1" value="0" oninput="updateRegressionUI()">
            
            <div class="flex justify-between text-xs mt-2 mb-1 text-gray-600">
                <span>End Date</span>
                <span id="reg-end-date" class="font-mono font-bold">-</span>
            </div>
            <input type="range" id="input-reg-end" min="0" max="10" step="1" value="10" oninput="updateRegressionUI()">
            
            <div class="text-[10px] text-gray-400 mt-2 text-center">Select data range used for Auto-Fit</div>
        </div>

        <button class="st-button success" onclick="runRegression()">âš¡ Auto-Fit (Regression)</button>

        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 1.5rem 0;">

        <!-- HISTORICAL DATA SOURCE -->
        <label class="slider-label" style="display:block; margin-bottom:0.5rem;">Historical Data Source</label>
        
        <!-- WELL INFO SECTION (MOVED HERE) -->
        <div class="mb-4 p-3 bg-white rounded border border-gray-200 shadow-sm">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Well Information</label>
            <div class="grid grid-cols-1 gap-3">
                <div>
                    <label class="text-xs text-gray-600 block mb-1 font-semibold">Well Name</label>
                    <input type="text" id="input-well-name" class="w-full border border-gray-300 rounded px-2 py-1 text-sm text-gray-800 focus:border-red-500 focus:outline-none" value="" onchange="updateProjectInfo()">
                </div>
                <div>
                    <label class="text-xs text-gray-600 block mb-1 font-semibold">Zone</label>
                    <input type="text" id="input-zone-name" class="w-full border border-gray-300 rounded px-2 py-1 text-sm text-gray-800 focus:border-red-500 focus:outline-none" value="" onchange="updateProjectInfo()">
                </div>
            </div>
        </div>
        
        <!-- GAS UNIT OPTION (RESTORED HERE) -->
        <div id="gasUnitContainer" style="display:none; margin-bottom: 1rem; padding: 0.5rem; background-color: #e6f3ff; border-radius: 4px; border: 1px solid #bce0fd;">
            <label class="slider-label" style="font-size:12px; color:var(--secondary-color);">Gas Data Input Unit</label>
            <div class="st-radio-group" style="margin-bottom: 0.25rem; margin-top: 0.25rem;">
                <label class="st-radio-option" style="font-size: 12px;">
                    <input type="radio" name="gasUnit" value="mscfd" onchange="handleGasUnitChange()"> Mscfd
                </label>
                <label class="st-radio-option" style="font-size: 12px;">
                    <input type="radio" name="gasUnit" value="mmscfd" checked onchange="handleGasUnitChange()"> MMscfd
                </label>
            </div>
            <div class="text-[10px] text-gray-500 italic">Selection will auto-convert value to MMscfd for plot.</div>
        </div>

        <!-- Tab Buttons -->
        <div class="flex gap-2 mb-4 text-xs">
            <button class="px-3 py-1 bg-white border rounded hover:border-red-500 transition-colors" onclick="switchInputTab('example')">Example</button>
            <button class="px-3 py-1 bg-white border rounded hover:border-red-500 transition-colors" onclick="switchInputTab('upload')">Upload</button>
            <button class="px-3 py-1 bg-white border rounded hover:border-red-500 transition-colors" onclick="switchInputTab('paste')">Paste</button>
        </div>

        <!-- TAB: EXAMPLE -->
        <div id="tab-example" class="input-tab bg-blue-50 p-3 rounded border border-blue-100 mb-4">
            <div class="text-xs text-blue-800 mb-2">Use built-in example data based on Fluid Type.</div>
            <button class="st-button primary" onclick="loadExampleData()" style="margin:0; font-size:12px;">Load Example Data</button>
        </div>

        <!-- TAB: UPLOAD -->
        <div id="tab-upload" class="input-tab bg-white p-3 rounded border mb-4">
             <div class="text-xs text-gray-500 mb-2"><b>CSV File</b></div>
             <div class="text-[10px] text-gray-400 mb-2">
                 Format: <b>Date, FTHP (psi), <span id="label-upload-rate">Oil Rate (BOPD)</span></b>
             </div>
             <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(this)" style="font-size: 11px; width: 100%;">
        </div>

        <!-- TAB: PASTE -->
        <div id="tab-paste" class="input-tab bg-white p-3 rounded border mb-4">
            <div class="text-xs text-gray-500 mb-2" id="hint-paste-format">
                Format: <code>Date [tab] FTHP (psi) [tab] Rate (BOPD)</code>
            </div>
            <div class="text-[10px] text-gray-400 mb-1">Supports <code>DD/MM/YYYY</code> or <code>YYYY-MM-DD</code></div>
            <textarea id="historyPasteArea" class="st-textarea" placeholder="01/01/2023	400	1000..." oninput="handleHistoryPaste(this.value)"></textarea>
            <button class="st-button" onclick="clearHistory()" style="margin-top:5px; font-size:12px;">Clear Data</button>
        </div>

        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 1.5rem 0;">

        <!-- PROJECT MANAGEMENT (MOVED HERE) -->
        <div class="mb-6 p-3 bg-gray-100 rounded border border-gray-200">
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Project Management</h3>
            <div class="flex gap-2">
                <button class="st-button success" onclick="saveProjectCSV()" style="margin:0; font-size:12px;">
                    <i class="fas fa-file-csv mr-1"></i> Save CSV
                </button>
                <button class="st-button" onclick="document.getElementById('projectFileInput').click()" style="margin:0; font-size:12px;">
                    <i class="fas fa-folder-open mr-1"></i> Load File
                </button>
                <input type="file" id="projectFileInput" accept=".json,.csv,.txt" onchange="loadProject(this)">
            </div>
            <div class="text-[10px] text-gray-400 mt-1">Supports editable CSV format.</div>
        </div>

    </div>

    <!-- MAIN CONTENT -->
    <div id="main-container">
        <h1 class="text-2xl font-bold mb-4">Decline Curve Analysis (DCA)</h1>
        
        <!-- CONTROL BAR (Log Scale + FTHP Toggle) -->
        <div class="flex items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <input type="checkbox" id="logScaleToggle" onchange="updateDCA(false)" class="w-4 h-4 text-red-600 rounded">
                <label for="logScaleToggle" class="text-sm font-medium">Logarithmic Scale</label>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="showFTHPToggle" onchange="updateDCA(false)" class="w-4 h-4 text-green-600 rounded">
                <label for="showFTHPToggle" class="text-sm font-medium">Show FTHP (Pressure)</label>
            </div>
        </div>

        <!-- Plotly Chart -->
        <div id="dcaChart" style="width: 100%; height: 550px; margin-bottom: 2rem; border: 1px solid #eee; border-radius: 8px;"></div>

        <!-- Results Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white border p-4 rounded-lg shadow-sm">
                <div class="text-xs text-gray-500">EUR (Est. Ult. Recovery)</div>
                <div class="text-2xl font-bold text-red-500">
                    <span id="res-eur">0.00</span> <span class="text-sm text-gray-700 unit-vol">MBO</span>
                </div>
            </div>
            <div class="bg-white border p-4 rounded-lg shadow-sm">
                <div class="text-xs text-gray-500">Remaining Reserves</div>
                <div class="text-2xl font-bold text-green-500">
                    <span id="res-rem">0.00</span> <span class="text-sm text-gray-700 unit-vol">MBO</span>
                </div>
            </div>
            <div class="bg-white border p-4 rounded-lg shadow-sm">
                <div class="text-xs text-gray-500">Cum. Production (Hist)</div>
                <div class="text-2xl font-bold text-gray-800">
                    <span id="res-cum">0.00</span> <span class="text-sm text-gray-700 unit-vol">MBO</span>
                </div>
            </div>
             <div class="bg-white border p-4 rounded-lg shadow-sm">
                <div class="text-xs text-gray-500">Est. End of Life</div>
                <div class="text-lg font-bold text-gray-800">
                    <span id="res-eol">-</span>
                </div>
            </div>
        </div>

        <!-- FORECAST TABLE SECTION -->
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold">Forecast Table</h3>
            <div class="flex items-center gap-2">
                <div class="flex bg-gray-100 rounded p-1 text-xs">
                    <button class="px-3 py-1 rounded bg-white shadow-sm font-semibold" id="btn-month" onclick="setTableView('month')">Monthly</button>
                    <button class="px-3 py-1 rounded hover:bg-white hover:shadow-sm transition-all" id="btn-day" onclick="setTableView('day')">Daily</button>
                    <button class="px-3 py-1 rounded hover:bg-white hover:shadow-sm transition-all" id="btn-year" onclick="setTableView('year')">Yearly</button>
                </div>
                
                <button id="btn-copy" onclick="copyTable()" class="px-3 py-1 bg-blue-600 text-white text-xs font-semibold rounded hover:bg-blue-700 transition-colors flex items-center gap-1">
                    <i class="fas fa-copy"></i> Copy
                </button>

                <button onclick="downloadCSV()" class="px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded hover:bg-green-700 transition-colors flex items-center gap-1">
                    <i class="fas fa-download"></i> CSV
                </button>
            </div>
        </div>
        
        <div style="overflow-x: auto; font-size: 12px; max-height: 400px; border: 1px solid #eee; border-radius: 4px;">
            <table class="w-full text-left border-collapse relative">
                <thead class="sticky top-0 bg-gray-50 shadow-sm z-10">
                    <tr class="border-b">
                        <th class="p-2">Date / Year</th>
                        <th class="p-2">Rate (<span class="unit-rate">BOPD</span>)</th>
                        <th class="p-2">Volume (<span class="unit-vol-small">Bbl</span>)</th>
                        <th class="p-2">Cummulative Forecast (<span class="unit-vol">MBO</span>)</th>
                    </tr>
                </thead>
                <tbody id="forecastTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let fluidType = 'oil'; 
        let historyData = []; // { date, fthp, q (in stored unit) }
        let tableView = 'month';
        let currentForecastData = []; 
        let gasInputUnit = 'mmscfd'; // 'mscfd' or 'mmscfd'
        let wellName = '';
        let zoneName = '';

        // Init Input Tabs
        function switchInputTab(tabName) {
            document.querySelectorAll('.input-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        switchInputTab('example');

        // --- 0. PROJECT MANAGEMENT (CSV / JSON) ---
        
        function saveProjectCSV() {
            let csv = "[PARAMETERS]\nParameter,Value\n";
            csv += `wellName,${wellName}\n`;
            csv += `zoneName,${zoneName}\n`;
            csv += `fluidType,${fluidType}\n`;
            csv += `gasInputUnit,${gasInputUnit}\n`;
            csv += `qi,${document.getElementById('input-qi').value}\n`;
            csv += `di,${document.getElementById('input-di').value}\n`;
            csv += `b,${document.getElementById('input-b').value}\n`;
            csv += `months,${document.getElementById('input-months').value}\n`;
            csv += `el,${document.getElementById('input-el').value}\n`;
            csv += `dateStart,${document.getElementById('input-date-start').value}\n`;
            csv += `timeShift,${document.getElementById('input-time-shift').value}\n`;
            csv += `regEnabled,${document.getElementById('check-reg-window').checked}\n`;
            csv += `regStart,${document.getElementById('input-reg-start').value}\n`;
            csv += `regEnd,${document.getElementById('input-reg-end').value}\n`;
            csv += `logScale,${document.getElementById('logScaleToggle').checked}\n`;
            csv += `showFTHP,${document.getElementById('showFTHPToggle').checked}\n`;
            
            // Just store whatever is current historyData
            // Column names adapt to fluidType just for labeling
            const rateLabel = fluidType === 'gas' ? 'GasRate' : 'OilRate';
            csv += `\n[HISTORY]\nDate,FTHP,${rateLabel}\n`;
            historyData.forEach(d => {
                const dateStr = d.date.toISOString().split('T')[0];
                csv += `${dateStr},${d.fthp || 0},${d.q}\n`;
            });

            const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "dca_project_data.csv");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadProject(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                if(content.trim().startsWith("{")) {
                    loadJSONProject(content); // Legacy JSON support (simplified)
                } else if(content.includes("[PARAMETERS]")) {
                    loadCSVProject(content);
                } else {
                    alert("Unknown file format.");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function loadCSVProject(csvText) {
            try {
                const lines = csvText.split(/\r?\n/);
                let section = "";
                let params = {};
                let newHistory = [];

                lines.forEach(line => {
                    const cleanLine = line.trim();
                    if(!cleanLine) return;
                    
                    if(cleanLine === "[PARAMETERS]") { section = "PARAMS"; return; }
                    if(cleanLine === "[HISTORY]") { section = "HISTORY"; return; } // Old format
                    if(cleanLine === "[HISTORY_RAW]") { section = "HISTORY"; return; } // Transition format
                    if(cleanLine.startsWith("[HISTORY]")) { section = "HISTORY"; return; } // Generic match
                    
                    if(section === "PARAMS") {
                        const parts = cleanLine.split(",");
                        if(parts.length >= 2 && parts[0] !== "Parameter") {
                            let val = parts[1];
                            if(val === "true") val = true;
                            if(val === "false") val = false;
                            params[parts[0]] = val;
                        }
                    } else if(section === "HISTORY") {
                        const parts = cleanLine.split(",");
                        if(parts.length >= 2 && parts[0] !== "Date") {
                            // Try to detect column count
                            // Format requested: Date, FTHP, Rate
                            // But backward compatibility needed
                            const d = parseDate(parts[0]);
                            if(d && !isNaN(d.getTime())) {
                                // Default assignment if 3 cols: Date, FTHP, Rate
                                // If 2 cols: Date, Rate (assume FTHP=0)
                                let fthp = 0;
                                let rate = 0;
                                
                                if(parts.length === 2) {
                                    rate = parseFloat(parts[1]);
                                } else if (parts.length >= 3) {
                                    fthp = parseFloat(parts[1]);
                                    rate = parseFloat(parts[2]);
                                }
                                
                                if(!isNaN(rate)) {
                                    newHistory.push({ date: d, fthp: fthp || 0, q: rate });
                                }
                            }
                        }
                    }
                });

                applyLoadedData(params, newHistory);
                alert("Project loaded successfully!");

            } catch (err) { console.error(err); alert("Error parsing CSV project file."); }
        }

        function loadJSONProject(jsonText) {
             try {
                const state = JSON.parse(jsonText);
                const params = {
                    fluidType: state.fluidType,
                    qi: state.params.qi,
                    di: state.params.di,
                    b: state.params.b,
                    months: state.params.months,
                    el: state.params.el,
                    dateStart: state.params.dateStart,
                    timeShift: state.params.timeShift
                };
                // Fallback map
                const newHistory = (state.historyData || []).map(d => ({ 
                    date: new Date(d.date), 
                    q: d.q,
                    fthp: d.fthp || 0
                }));
                applyLoadedData(params, newHistory);
            } catch(e) { alert("Error loading JSON"); }
        }

        function applyLoadedData(params, newHistory) {
            fluidType = params.fluidType || 'oil';
            gasInputUnit = params.gasInputUnit || 'mmscfd';
            wellName = params.wellName || '';
            // Handle legacy "layerName" or new "zoneName"
            zoneName = params.zoneName || params.layerName || '';
            
            // Set UI for well/zone
            document.getElementById('input-well-name').value = wellName;
            document.getElementById('input-zone-name').value = zoneName;

            // Set Radios
            const fRadios = document.getElementsByName('fluidType');
            for(const r of fRadios) { if(r.value === fluidType) r.checked = true; }
            const gRadios = document.getElementsByName('gasUnit');
            for(const r of gRadios) { if(r.value === gasInputUnit) r.checked = true; }

            // Set Data
            const sorted = newHistory.sort((a,b) => a.date - b.date);
            processHistoryData(sorted);

            // Params
            if(params.qi) document.getElementById('input-qi').value = params.qi;
            if(params.di) document.getElementById('input-di').value = params.di;
            if(params.b) document.getElementById('input-b').value = params.b;
            if(params.months) document.getElementById('input-months').value = params.months;
            if(params.el) document.getElementById('input-el').value = params.el;

            ['qi', 'di', 'b', 'months', 'el'].forEach(id => {
                document.getElementById(`input-${id}-num`).value = document.getElementById(`input-${id}`).value;
            });

            if(params.dateStart) document.getElementById('input-date-start').value = params.dateStart;
            if(params.timeShift) {
                document.getElementById('input-time-shift').value = params.timeShift;
                document.getElementById('val-time-shift').innerText = (parseInt(params.timeShift) > 0 ? "+" : "") + params.timeShift;
            }

            // Restore FTHP Toggle
            if(params.showFTHP !== undefined) {
                document.getElementById('showFTHPToggle').checked = (String(params.showFTHP) === "true");
            }

            updateFluidSettings();
            updateDCA(false);
        }

        // --- HANDLERS ---
        function updateProjectInfo() {
            wellName = document.getElementById('input-well-name').value;
            zoneName = document.getElementById('input-zone-name').value;
            updateDCA(false);
        }

        function handleFluidChange() {
            const radios = document.getElementsByName('fluidType');
            for(const r of radios) { if(r.checked) fluidType = r.value; }
            updateFluidSettings();
            updateDCA(false);
        }

        function handleGasUnitChange() {
            const radios = document.getElementsByName('gasUnit');
            for(const r of radios) { if(r.checked) gasInputUnit = r.value; }
            updateFluidSettings();
            updateDCA(false);
        }

        function processHistoryData(data) {
             if(data.length === 0) {
                historyData = [];
                return;
            }
            
            // Calculate t_months
            const startMs = data[0].date.getTime();
            historyData = data.map(d => ({
                date: d.date,
                fthp: d.fthp,
                q: d.q,
                t_months: (d.date.getTime() - startMs) / (1000 * 60 * 60 * 24 * 30.44)
            }));
            
            initRegressionSliders();
        }

        // --- PARSING ---
        function parseDate(dateStr) {
            if(!dateStr) return null;
            // Handle DD/MM/YYYY
            if(dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if(parts.length === 3) {
                    if(parts[2].length === 4) {
                        return new Date(parts[2], parts[1]-1, parts[0]);
                    }
                }
            }
            // Fallback
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function parseRawLine(line) {
            // New Requirement: Date, FTHP, Rate
            const cols = line.trim().split(/[\t,]+/);
            if(cols.length < 2) return null;

            const d = parseDate(cols[0]);
            if(!d || isNaN(d.getTime())) return null;

            // Col 1 is FTHP
            const fthp = parseFloat(cols[1]);
            
            // Col 2 is Rate
            // If only 2 cols, maybe user pasted Date, Rate?
            // User explicit request: "date, fthp, rate"
            // Let's support graceful degradation. If 2 cols found, assume Date, Rate?
            // Or strictly follow instruction?
            // "urutannya menjadi date, fthp, oil rate" implies 3 cols.
            // But if user pastes just 2, we might miss Rate.
            // Let's try: if 3 cols -> Date, FTHP, Rate. If 2 cols -> Date, Rate (FTHP=0).
            
            let rate = 0;
            let finalFthp = 0;

            if(cols.length >= 3) {
                finalFthp = isNaN(fthp) ? 0 : fthp;
                rate = parseFloat(cols[2]);
            } else if (cols.length === 2) {
                // Ambiguous. Assuming Date, Rate for compatibility with simple lists
                rate = parseFloat(cols[1]);
            }

            if(isNaN(rate)) return null;

            return {
                date: d,
                fthp: finalFthp,
                q: rate
            };
        }

        // --- DATA INPUT ---
        function loadExampleData() {
            const data = [];
            const start = new Date();
            start.setMonth(start.getMonth() - 24);
            let q = fluidType === 'oil' ? 1000 : 5000; 
            let fthp = 400;

            // If gas, let's say 5000 mscfd or 5 mmscfd
            // Let's use 5.0 and set unit to mmscfd
            if(fluidType === 'gas') {
                q = 5.0;
                document.querySelector('input[name="gasUnit"][value="mmscfd"]').checked = true;
                gasInputUnit = 'mmscfd';
            }

            for(let i=0; i<24; i++) {
                const d = new Date(start);
                d.setMonth(start.getMonth() + i);
                
                // decline
                q = q * Math.exp(-0.02) * (0.95 + Math.random()*0.1);
                fthp = fthp * 0.98;

                data.push({
                    date: d,
                    fthp: Math.round(fthp),
                    q: q
                });
            }
            
            const sorted = data.sort((a,b) => a.date - b.date);
            processHistoryData(sorted);
            
            // Set Date Start
            if(historyData.length > 0) {
                const lastDate = historyData[historyData.length-1].date;
                const nextDay = new Date(lastDate);
                document.getElementById('input-date-start').valueAsDate = nextDay;
                document.getElementById('input-time-shift').value = 0;
            }
            updateDCA(false);
        }

        function handleHistoryPaste(text) {
            if(!text) return;
            const rows = text.trim().split(/\r?\n/);
            const newData = [];
            rows.forEach(row => {
                const item = parseRawLine(row);
                if(item) newData.push(item);
            });
            if(newData.length > 0) {
                const sorted = newData.sort((a,b) => a.date - b.date);
                processHistoryData(sorted);
                const lastDate = historyData[historyData.length-1].date;
                document.getElementById('input-date-start').valueAsDate = new Date(lastDate);
                updateDCA(false);
            }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.trim().split(/\r?\n/);
                const newData = [];
                // Skip header if non-numeric
                let startIdx = 0;
                if(rows.length > 0 && isNaN(parseFloat(rows[0].split(/[\t,]+/)[1]))) startIdx = 1;
                
                for(let i = startIdx; i < rows.length; i++) {
                    const item = parseRawLine(rows[i]);
                    if(item) newData.push(item);
                }
                
                if(newData.length > 0) {
                    const sorted = newData.sort((a,b) => a.date - b.date);
                    processHistoryData(sorted);
                    updateDCA(false);
                }
            };
            reader.readAsText(file);
        }

        function clearHistory() {
            historyData = [];
            document.getElementById('historyPasteArea').value = '';
            updateDCA(false);
        }

        // --- UI SYNC ---

        function syncInput(id, source) {
            const slider = document.getElementById(`input-${id}`);
            const num = document.getElementById(`input-${id}-num`);
            if (source === 'slider') { num.value = slider.value; } else { slider.value = num.value; }
            updateDCA(false);
        }

        function toggleRegWindow() {
            const isChecked = document.getElementById('check-reg-window').checked;
            document.getElementById('reg-window-container').style.display = isChecked ? 'block' : 'none';
            updateDCA(false);
        }

        function updateRegressionUI() {
            if(historyData.length === 0) return;
            const startIdx = parseInt(document.getElementById('input-reg-start').value);
            const endIdx = parseInt(document.getElementById('input-reg-end').value);
            if(startIdx > endIdx) document.getElementById('input-reg-start').value = endIdx;
            
            const validStart = parseInt(document.getElementById('input-reg-start').value);
            const validEnd = parseInt(document.getElementById('input-reg-end').value);
            
            document.getElementById('reg-start-date').innerText = historyData[validStart]?.date.toLocaleDateString() || "-";
            document.getElementById('reg-end-date').innerText = historyData[validEnd]?.date.toLocaleDateString() || "-";
            updateDCA(false); 
        }

        function initRegressionSliders() {
            const maxIdx = Math.max(0, historyData.length - 1);
            const sStart = document.getElementById('input-reg-start');
            const sEnd = document.getElementById('input-reg-end');
            sStart.max = maxIdx; sStart.value = 0;
            sEnd.max = maxIdx; sEnd.value = maxIdx;
            updateRegressionUI();
        }

        function handleTimeShiftSlider() {
            const shiftMonths = parseInt(document.getElementById('input-time-shift').value);
            document.getElementById('val-time-shift').innerText = shiftMonths > 0 ? `+${shiftMonths}` : shiftMonths;
            let baseDate = new Date();
            if(historyData.length > 0) baseDate = new Date(historyData[historyData.length-1].date);
            const newDate = new Date(baseDate);
            newDate.setMonth(baseDate.getMonth() + shiftMonths);
            document.getElementById('input-date-start').valueAsDate = newDate;
            updateDCA(false);
        }

        function handleDateInput() {
            const inputDate = document.getElementById('input-date-start').valueAsDate;
            if(!inputDate) return;
            let baseDate = new Date();
            if(historyData.length > 0) baseDate = new Date(historyData[historyData.length-1].date);
            const diffTime = inputDate - baseDate;
            const diffMonths = Math.round(diffTime / (1000 * 60 * 60 * 24 * 30.44));
            const slider = document.getElementById('input-time-shift');
            if(diffMonths > slider.max) slider.max = diffMonths + 12;
            if(diffMonths < slider.min) slider.min = diffMonths - 12;
            slider.value = diffMonths;
            document.getElementById('val-time-shift').innerText = diffMonths > 0 ? `+${diffMonths}` : diffMonths;
            updateDCA(false);
        }

        function updateFluidSettings() {
            const qiSlider = document.getElementById('input-qi');
            const elSlider = document.getElementById('input-el');
            const gasContainer = document.getElementById('gasUnitContainer');
            const uploadLabel = document.getElementById('label-upload-rate');
            const pasteLabel = document.getElementById('hint-paste-format');
            
            // Get current gas unit from DOM if updated
            const currentGasUnit = document.querySelector('input[name="gasUnit"]:checked')?.value || 'mmscfd';
            let rateUnit = 'BOPD';
            if(fluidType === 'gas') {
                rateUnit = (currentGasUnit === 'mscfd') ? 'Mscfd' : 'MMscfd';
            }

            if (fluidType === 'oil') {
                qiSlider.min = 10; qiSlider.max = 5000; qiSlider.step = 1; 
                if(parseFloat(qiSlider.value) > 5000) qiSlider.value = 1000;
                elSlider.max = 500; elSlider.step = 1;
                updateUnitLabels('BOPD', 'MBO', 'Bbl');
                
                gasContainer.style.display = 'none';
                uploadLabel.innerText = "Oil Rate (BOPD)";
                if(pasteLabel) pasteLabel.innerHTML = 'Format: <code>Date [tab] FTHP (psi) [tab] Rate (BOPD)</code>';
            } else {
                qiSlider.min = 0.1; qiSlider.max = 100; qiSlider.step = 0.1;
                if(parseFloat(qiSlider.value) > 100) qiSlider.value = 10;
                elSlider.max = 10; elSlider.step = 0.01;
                updateUnitLabels('MMscfd', 'Bscf', 'MMscf');
                
                gasContainer.style.display = 'block';
                uploadLabel.innerText = `Gas Rate (${rateUnit})`;
                if(pasteLabel) pasteLabel.innerHTML = `Format: <code>Date [tab] FTHP (psi) [tab] Rate (${rateUnit})</code>`;
            }
            ['qi', 'di', 'b', 'months', 'el'].forEach(id => {
                document.getElementById(`input-${id}-num`).value = document.getElementById(`input-${id}`).value;
            });
        }

        function updateUnitLabels(rate, volBig, volSmall) {
            document.querySelectorAll('.unit-rate').forEach(el => el.innerText = rate);
            document.querySelectorAll('.unit-vol').forEach(el => el.innerText = volBig);
            document.querySelectorAll('.unit-vol-small').forEach(el => el.innerText = volSmall);
            document.getElementById('unit-qi').innerText = rate;
            document.getElementById('unit-el').innerText = rate;
        }

        function setTableView(mode) {
            tableView = mode;
            const btns = { month: 'btn-month', day: 'btn-day', year: 'btn-year' };
            const activeClass = "px-3 py-1 rounded bg-white shadow-sm font-semibold";
            const inactiveClass = "px-3 py-1 rounded hover:bg-white hover:shadow-sm transition-all";
            Object.keys(btns).forEach(k => {
                document.getElementById(btns[k]).className = (k === mode) ? activeClass : inactiveClass;
            });
            updateDCA(false);
        }

        // --- CALCULATION ---
        function calculateDCA() {
            const qi = parseFloat(document.getElementById('input-qi').value);
            const Di_pct_yr = parseFloat(document.getElementById('input-di').value);
            const b = parseFloat(document.getElementById('input-b').value);
            const forecastMonthsSlider = parseFloat(document.getElementById('input-months').value);
            const q_el = parseFloat(document.getElementById('input-el').value);
            const startDateInput = document.getElementById('input-date-start').valueAsDate || new Date();
            const Di_m = (Di_pct_yr / 100) / 12;

            let histCum = 0;
            const fitLine = [];
            
            // Prepare Data with Unit Factor
            const factor = (fluidType === 'gas' && gasInputUnit === 'mscfd') ? 0.001 : 1.0;

            if (historyData.length > 0) {
                for(let i=0; i<historyData.length; i++) {
                     let days = 0;
                     if (i < historyData.length - 1) {
                         days = (historyData[i+1].date - historyData[i].date) / (1000 * 60 * 60 * 24);
                     } else {
                         days = (i > 0) ? (historyData[i].date - historyData[i-1].date) / (1000 * 60 * 60 * 24) : 1;
                     }
                     if(days <= 0) days = 1; 

                     const val = historyData[i].q * factor;
                     const vol = val * days; 
                     histCum += vol;

                     const t = historyData[i].t_months;
                     let q_model = 0;
                     if(b === 0) q_model = qi * Math.exp(-Di_m * t);
                     else q_model = qi / Math.pow((1 + b * Di_m * t), (1/b));
                     fitLine.push({ t: t, q: q_model, date: historyData[i].date });
                }
            }

            let t_offset = 0;
            if(historyData.length > 0) {
                const startHist = historyData[0].date;
                t_offset = (startDateInput - startHist) / (1000 * 60 * 60 * 24 * 30.44);
            }

            const forecastLine = []; 
            const forecastTableData = []; 
            let remReserves = 0;
            let eolDate = "-";
            
            // Forecast Generation
            for(let m = 0; m <= forecastMonthsSlider; m++) {
                const t = t_offset + m;
                let q_calc = 0;
                const t_safe = Math.max(0, t);
                if(b === 0) q_calc = qi * Math.exp(-Di_m * t_safe);
                else q_calc = qi / Math.pow((1 + b * Di_m * t_safe), (1/b));
                if(q_calc < q_el) q_calc = 0; 

                const currentD = new Date(startDateInput);
                currentD.setMonth(startDateInput.getMonth() + m);
                forecastLine.push({ t: t, q: q_calc, date: currentD });
            }

            // Table
            let cumForecast = 0;
            let m = 0;
            let productionActive = true;
            
            if(tableView === 'year') {
                let yearVol = 0; let monthsInYear = 0; let yearCount = 1;
                while(productionActive && m < 1200) {
                    const t = t_offset + m;
                    const t_safe = Math.max(0, t);
                    let q = (b === 0) ? qi * Math.exp(-Di_m * t_safe) : qi / Math.pow((1 + b * Di_m * t_safe), (1/b));
                    if(q < q_el) {
                        productionActive = false; q = 0;
                        const d = new Date(startDateInput); d.setMonth(startDateInput.getMonth() + m); eolDate = d.toLocaleDateString();
                    } else {
                        const vol = q * 30.44; yearVol += vol; remReserves += vol; cumForecast += vol; monthsInYear++;
                        if ((m + 1) % 12 === 0) {
                            forecastTableData.push({ 
                                label: `Year ${yearCount}`, q: yearVol/365.25, vol: yearVol, cum: cumForecast, isYearly: true
                            });
                            yearVol = 0; monthsInYear = 0; yearCount++;
                        }
                    }
                    m++;
                }
                if(yearVol > 0) {
                   forecastTableData.push({ 
                       label: `Year ${yearCount}`, q: yearVol/(monthsInYear*30.44), vol: yearVol, cum: cumForecast, isYearly: true 
                   });
                }
            } else if(tableView === 'month') {
                while(productionActive && m < 1200) {
                    const t = t_offset + m;
                    const t_safe = Math.max(0, t);
                    let q = (b === 0) ? qi * Math.exp(-Di_m * t_safe) : qi / Math.pow((1 + b * Di_m * t_safe), (1/b));
                    if(q < q_el) {
                        productionActive = false; q = 0;
                        const d = new Date(startDateInput); d.setMonth(startDateInput.getMonth() + m); eolDate = d.toLocaleDateString();
                    } else {
                        const vol = q * 30.44; remReserves += vol; cumForecast += vol;
                        const d = new Date(startDateInput); d.setMonth(startDateInput.getMonth() + m);
                        forecastTableData.push({ date: d, q: q, vol: vol, cum: cumForecast });
                    }
                    m++;
                }
            } else { // Daily
                let d_count = 0;
                while(productionActive && d_count < 3650) { 
                     const t_days = (t_offset * 30.44) + d_count;
                     const t_safe = Math.max(0, t_days / 30.44);
                     let q = (b === 0) ? qi * Math.exp(-Di_m * t_safe) : qi / Math.pow((1 + b * Di_m * t_safe), (1/b));
                     if(q < q_el) { 
                         productionActive = false; q = 0;
                         const d = new Date(startDateInput); d.setDate(startDateInput.getDate() + d_count); eolDate = d.toLocaleDateString();
                     } else {
                         const vol = q * 1; remReserves += vol; cumForecast += vol;
                         const d = new Date(startDateInput); d.setDate(startDateInput.getDate() + d_count);
                         forecastTableData.push({ date: d, q: q, vol: vol, cum: cumForecast });
                     }
                     d_count++;
                }
            }
            if(eolDate === "-") eolDate = "> 100 Years";

            return { fitLine, forecastLine, forecastTableData, histCum, remReserves, eolDate };
        }

        async function runRegression() {
            if(historyData.length < 3) { alert("Need at least 3 historical data points."); return; }
            
            const useWindow = document.getElementById('check-reg-window').checked;
            let regressionData = [];
            
            // Factor for regression
            const factor = (fluidType === 'gas' && gasInputUnit === 'mscfd') ? 0.001 : 1.0;
            
            // Create regression dataset with APPLIED factor
            const regSource = historyData.map(d => ({
                t_months: d.t_months,
                q: d.q * factor
            }));

            if (useWindow) {
                const regStartIdx = parseInt(document.getElementById('input-reg-start').value);
                const regEndIdx = parseInt(document.getElementById('input-reg-end').value);
                if(regStartIdx >= regEndIdx) { alert("Invalid Window."); return; }
                regressionData = regSource.slice(regStartIdx, regEndIdx + 1);
            } else {
                regressionData = regSource;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';
            await new Promise(r => setTimeout(r, 100));

            let bestSSE = Infinity;
            const qiMin = parseFloat(document.getElementById('input-qi').min);
            const qiMax = parseFloat(document.getElementById('input-qi').max);
            const bMax = 1.0; 
            let bestParams = { qi: 1000, di: 20, b: 0.5 };
            let currentParams = {
                qi: parseFloat(document.getElementById('input-qi').value),
                di: parseFloat(document.getElementById('input-di').value),
                b: parseFloat(document.getElementById('input-b').value)
            };
            const iterations = 2000;
            let temp = 100;
            
            for(let i=0; i<iterations; i++) {
                const nextParams = {
                    qi: currentParams.qi + (Math.random()-0.5) * temp * (fluidType==='gas'?5:10),
                    di: currentParams.di + (Math.random()-0.5) * temp * 0.5,
                    b: currentParams.b + (Math.random()-0.5) * temp * 0.05
                };
                nextParams.qi = Math.max(qiMin, Math.min(qiMax, nextParams.qi));
                nextParams.di = Math.max(1, Math.min(300, nextParams.di));
                nextParams.b = Math.max(0, Math.min(bMax, nextParams.b));

                const error = calculateSSE(nextParams, regressionData);
                if (error < bestSSE) {
                    bestSSE = error; bestParams = {...nextParams}; currentParams = {...nextParams};
                } else {
                    if (Math.random() < Math.exp((bestSSE - error) / temp)) currentParams = {...nextParams};
                }
                temp *= 0.995;
            }

            document.getElementById('input-qi').value = bestParams.qi;
            document.getElementById('input-di').value = bestParams.di;
            document.getElementById('input-b').value = bestParams.b;
            ['qi', 'di', 'b'].forEach(id => { document.getElementById(`input-${id}-num`).value = document.getElementById(`input-${id}`).value; });
            updateDCA(false);
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function calculateSSE(p, dataSubset) {
            let sse = 0;
            const Di_m = (p.di / 100) / 12;
            for(let i=0; i<dataSubset.length; i++) {
                const t = dataSubset[i].t_months;
                const actual = dataSubset[i].q;
                let model = (Math.abs(p.b) < 0.001) ? p.qi * Math.exp(-Di_m * t) : p.qi / Math.pow((1 + p.b * Di_m * t), (1/p.b));
                sse += Math.pow(actual - model, 2);
            }
            return sse;
        }

        function copyTable() {
            if(!currentForecastData || currentForecastData.length === 0) return;
            
            // Determine units
            const unitRate = fluidType === 'gas' ? 'MMscfd' : 'BOPD';
            const unitVol = fluidType === 'gas' ? 'MMscf' : 'Bbl';
            const unitCum = fluidType === 'gas' ? 'BSCF' : 'MBO';

            let text = `Date/Year\tRate (${unitRate})\tVolume (${unitVol})\tCummulative (${unitCum})\n`;
            
            currentForecastData.forEach(row => {
                const dateStr = row.isYearly ? row.label : row.date.toISOString().split('T')[0];
                // Divide cum by 1000 to convert Bbl->MBO or MMscf->Bscf
                const cumVal = row.cum / 1000;
                text += `${dateStr}\t${row.q.toFixed(2)}\t${row.vol.toFixed(2)}\t${cumVal.toFixed(2)}\n`;
            });

            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try { 
                document.execCommand('copy'); 
                const btn = document.getElementById('btn-copy');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied';
                setTimeout(() => btn.innerHTML = originalHtml, 2000);
            } catch (err) { alert("Failed to copy table."); }
            document.body.removeChild(ta);
        }

        function downloadCSV() {
            if(!currentForecastData || currentForecastData.length === 0) return;
            
            const unitRate = fluidType === 'gas' ? 'MMscfd' : 'BOPD';
            const unitVol = fluidType === 'gas' ? 'MMscf' : 'Bbl';
            const unitCum = fluidType === 'gas' ? 'BSCF' : 'MBO';

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Date/Year,Rate (${unitRate}),Volume (${unitVol}),Cummulative (${unitCum})\n`;
            
            currentForecastData.forEach(row => {
                const dateStr = row.isYearly ? row.label : row.date.toISOString().split('T')[0];
                // Divide cum by 1000 to convert Bbl->MBO or MMscf->Bscf
                const cumVal = row.cum / 1000;
                const rowStr = `${dateStr},${row.q.toFixed(2)},${row.vol.toFixed(2)},${cumVal.toFixed(2)}`;
                csvContent += rowStr + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `dca_forecast_${tableView}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateDCA(isRegression = false) {
            const res = calculateDCA();
            currentForecastData = res.forecastTableData; 
            const volDiv = fluidType === 'gas' ? 1000 : 1000;
            
            document.getElementById('res-eur').innerText = ((res.histCum + res.remReserves)/volDiv).toLocaleString(undefined, {maximumFractionDigits:1});
            document.getElementById('res-rem').innerText = (res.remReserves/volDiv).toLocaleString(undefined, {maximumFractionDigits:1});
            document.getElementById('res-cum').innerText = (res.histCum/volDiv).toLocaleString(undefined, {maximumFractionDigits:1});
            document.getElementById('res-eol').innerText = res.eolDate;

            // Table Render
            const tbody = document.getElementById('forecastTableBody');
            tbody.innerHTML = '';
            const renderLimit = 200;
            res.forecastTableData.slice(0, renderLimit).forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                const displayDate = row.isYearly ? row.label : row.date.toLocaleDateString();
                tr.innerHTML = `
                    <td class="p-2 text-gray-600">${displayDate}</td>
                    <td class="p-2 font-mono font-bold text-red-500">${fluidType==='gas' ? row.q.toFixed(2) : Math.round(row.q)}</td>
                    <td class="p-2 text-gray-600">${Math.round(row.vol).toLocaleString()}</td>
                    <td class="p-2 font-semibold text-gray-800">${(row.cum/1000).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                `;
                tbody.appendChild(tr);
            });
            if(res.forecastTableData.length > renderLimit) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="p-2 text-center text-gray-500 italic">... showing first ${renderLimit} rows (Download CSV for full dataset) ...</td>`;
                tbody.appendChild(tr);
            }

            // Plot
            const isLog = document.getElementById('logScaleToggle').checked;
            const showFTHP = document.getElementById('showFTHPToggle').checked;
            const factor = (fluidType === 'gas' && gasInputUnit === 'mscfd') ? 0.001 : 1.0;
            
            // Primary Rate Trace
            const traceHist = {
                x: historyData.map(d => d.date), y: historyData.map(d => d.q * factor),
                mode: 'markers', type: 'scatter', name: `History (${fluidType})`,
                marker: { color: '#333', size: 5, symbol: 'circle' }
            };

            // FTHP Trace
            const fthpX = [], fthpY = [];
            if(showFTHP) {
                historyData.forEach(d => { if(d.fthp > 0) { fthpX.push(d.date); fthpY.push(d.fthp); } });
            }
            const traceFthp = {
                x: fthpX, y: fthpY,
                mode: 'lines', type: 'scatter', name: 'FTHP (psi)',
                yaxis: 'y2', line: { color: 'green', width: 1.5, dash: 'dot' }
            };

            const traceFit = {
                x: res.fitLine.map(d => d.date), y: res.fitLine.map(d => d.q),
                mode: 'lines', type: 'scatter', name: 'Fit',
                line: { color: '#0083B8', width: 2, dash: 'dash' }
            };
            
            const fcstX = [], fcstY = [];
            res.forecastLine.forEach(pt => { if(pt.q > 0) { fcstX.push(pt.date); fcstY.push(pt.q); }});
            const traceFcst = {
                x: fcstX, y: fcstY,
                mode: 'lines', type: 'scatter', name: 'Forecast',
                line: { color: '#ff4b4b', width: 3 }
            };

            const q_el = parseFloat(document.getElementById('input-el').value);
            let limitX = [];
            if(historyData.length > 0) limitX.push(historyData[0].date);
            else if(fcstX.length > 0) limitX.push(fcstX[0]);
            const lastFcst = fcstX.length > 0 ? fcstX[fcstX.length-1] : new Date();
            limitX.push(lastFcst);
            const traceLimit = {
                x: limitX, y: [q_el, q_el],
                mode: 'lines', name: 'Eco. Limit',
                line: { color: 'orange', dash: 'dot', width: 1 }
            };

             // Regression Window Shape
            const useWindow = document.getElementById('check-reg-window').checked;
            let shapes = [];
            if (useWindow) {
                const regStartIdx = parseInt(document.getElementById('input-reg-start').value);
                const regEndIdx = parseInt(document.getElementById('input-reg-end').value);
                if(historyData.length > 0 && regStartIdx >= 0 && regEndIdx < historyData.length) {
                    shapes.push({
                        type: 'rect', xref: 'x', yref: 'paper', x0: historyData[regStartIdx].date, x1: historyData[regEndIdx].date, 
                        y0: 0, y1: 1, fillcolor: 'rgba(0, 131, 184, 0.1)', line: { width: 0 }
                    });
                }
            }

            // Traces array
            const traces = [traceHist, traceFit, traceFcst, traceLimit];
            if(showFTHP) {
                traces.push(traceFthp);
            }

            let plotTitle = "Production Rate vs Date";
            if(wellName.trim() !== "" || zoneName.trim() !== "") {
               const parts = [];
               if(wellName.trim()) parts.push(wellName);
               if(zoneName.trim()) parts.push(zoneName);
               plotTitle += `<br><span style="font-size: 14px; color: #555;">${parts.join(" | ")}</span>`;
            }

            const layout = {
                title: {
                    text: plotTitle,
                    y: 0.95
                },
                font: { family: '"Source Sans Pro", sans-serif' },
                xaxis: { title: 'Date' },
                yaxis: { title: `Rate (${fluidType === 'gas' ? 'MMscfd' : 'BOPD'})`, type: isLog ? 'log' : 'linear' },
                yaxis2: showFTHP ? { 
                    title: 'FTHP (psi)', 
                    overlaying: 'y', 
                    side: 'right', 
                    showgrid: false, 
                    titlefont: {color:'green'}, 
                    tickfont: {color:'green'} 
                } : { visible: false },
                paper_bgcolor: 'white', plot_bgcolor: 'white',
                margin: { t: 60, r: showFTHP ? 50 : 20, l: 60, b: 40 },
                legend: { x: 1.1, xanchor: 'left', y: 1 },
                shapes: shapes
            };

            Plotly.react('dcaChart', traces, layout, {displayModeBar: false});
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        loadExampleData(); 
        updateFluidSettings();
        window.onresize = () => Plotly.Plots.resize('dcaChart');

    </script>
</body>
</html>
